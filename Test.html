<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
  body {
    font-family: 'Cairo', sans-serif;
    background: #f3f6fb;
  }
  .card {
    background: white;
    border-radius: 18px;
    padding: 28px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid #e6e9ef;
  }
  .input-box {
    border: 1px solid #d9dce3;
    border-radius: 10px;
    padding: 10px 14px;
    transition: 0.2s;
  }
  .input-box:focus {
    border-color: #6366f1;
    outline: none;
    box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
  }
  #reader {
    min-height: 240px;
    border: 2px dashed #c8d0dd;
    border-radius: 14px;
    background: #f1f5fb;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #64748b;
    font-weight: 600;
  }
  .result-box {
    border-radius: 12px;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 15px;
  }
</style>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="p-5 md:p-10">

<div class="max-w-xl mx-auto">

  <h2 class="text-3xl font-bold text-center text-gray-800 mb-8 select-none">
    <span class="text-pink-500 ml-2">ğŸ“Œ</span>
    Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
    <div class="w-32 mx-auto mt-3 border-b-2 border-indigo-300"></div>
  </h2>

  <div class="card mb-7">
    <label class="font-semibold text-gray-700 mb-2 block">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
    <input id="employeeName" class="w-full input-box" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" />

    <div style="margin-top: 25px;">
      <label class="font-semibold text-gray-700 mt-4 mb-2 block">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
      <select id="checkType" class="w-full input-box bg-white">
        <option value="Check-in">Ø­Ø¶ÙˆØ± (Check-in)</option>
        <option value="Check-out">Ø§Ù†ØµØ±Ø§Ù (Check-out)</option>
      </select>
    </div>
  </div>

  <div class="card">
    <h3 class="text-xl font-semibold text-gray-800 mb-4 select-none">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>

    <div id="reader" class="mb-5">Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§â€¦</div>

    <div class="space-y-3 text-sm">

      <div id="scanResult" class="result-box bg-blue-50 text-blue-700 border-r-4 border-blue-500">
        <span>ğŸ”—</span> <span>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</span>
      </div>

      <div id="locationOutput" class="result-box bg-green-50 text-green-700 border-r-4 border-green-500">
        <span>ğŸ“</span> <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</span>
      </div>

      <div id="serverOutput" class="result-box bg-gray-50 text-gray-700 border-r-4 border-gray-500 whitespace-pre-wrap">
        <span>â„¹ï¸</span> <span>Ø§Ù„Ù†ØªÙŠØ¬Ø© </span>
      </div>

    </div>
  </div>

</div>

<script>
let isProcessing = false;

// ===== Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =====
function showMessage(type, message) {
    const outputElement = document.getElementById("serverOutput");
    let baseClass = "result-box border-r-4 whitespace-pre-wrap";
    let icon = '';

    if (type === 'success') {
        outputElement.className = `${baseClass} bg-green-100 text-green-800 border-green-600`;
        icon = 'âœ…';
    } else if (type === 'warning') {
        outputElement.className = `${baseClass} bg-yellow-100 text-yellow-800 border-yellow-600`;
        icon = 'âš ï¸';
    } else {
        outputElement.className = `${baseClass} bg-red-100 text-red-800 border-red-600`;
        icon = 'âŒ';
    }

    outputElement.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
}

// ===== QR Scanner =====
var html5QrCode = new Html5Qrcode("reader");

function onScanSuccess(decodedText) {
  if (isProcessing) return;
  isProcessing = true;

  document.getElementById("scanResult").innerHTML =
    `<span>ğŸ”</span> <span>ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­: ${decodedText} (Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...)</span>`;

  html5QrCode.stop().then(() => processAttendance(decodedText));
}

function restartScanner() {
  setTimeout(() => {
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess)
    .catch(() => showMessage('error','âš ï¸ ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'));
  }, 800);
}

html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess)
  .catch(() => showMessage('error', 'âš ï¸ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'));  

// ===== GPS ONLY (Ø¨Ø¯ÙˆÙ† IP Ø£Ùˆ Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ) =====
function getLocationWithFallback(callback) {
  if (!("geolocation" in navigator)) {
    callback({
      error: true,
      message: "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS"
    });
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      callback({
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude,
        source: "GPS"
      });
    },
    err => {
      callback({
        error: true,
        message: "ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± GPS. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø²."
      });
    },
    { timeout: 10000, enableHighAccuracy: true }
  );
}

// ===== Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
function processAttendance(siteNameFromQR) {
  let employeeName = document.getElementById("employeeName").value.trim();
  let checkType = document.getElementById("checkType").value;

  if (!employeeName) {
    showMessage('warning', 'âš  ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø­.');
    isProcessing = false;
    restartScanner();
    return;
  }

  showMessage('warning', '... Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹');

  getLocationWithFallback(function(loc) {

    if (loc.error) {
      showMessage('error', loc.message);
      isProcessing = false;
      restartScanner();
      return;
    }

    document.getElementById("locationOutput").innerHTML =
      `<span>ğŸ“</span> <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${loc.latitude}, ${loc.longitude} (GPS)</span>`;

    sendAttendance(employeeName, siteNameFromQR, checkType, loc.latitude, loc.longitude);
  });
}

// ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
function sendAttendance(employeeName, siteName, checkType, userLat, userLon) {
  fetch("https://script.google.com/macros/s/AKfycbyiiDTOSUf8Hx9scY_vKkoaoXBmpq52wBaWF7iSWApJBrdLTygOMkaGrp0WyyuYKlFl/exec", {
    method: "POST",
    body: JSON.stringify({
      employeeName,
      siteName,
      checkType,
      timestamp: new Date().toLocaleString("sv-SE"),
      latitude: userLat,
      longitude: userLon
    })
  })
  .then(res => res.json())
  .then(resObj => {
    isProcessing = false;
    restartScanner();

    if (!resObj || resObj.result === undefined) {
      showMessage('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
      return;
    }

    if (resObj.result === "success") {
      showMessage('success', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ | ${checkType} | Ø§Ù„Ù…Ø³Ø§ÙØ©: ${Math.round(resObj.distance)} Ù…ØªØ±`);
    } else {
      showMessage('error', `ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${resObj.message}`);
    }
  })
  .catch(err => {
    isProcessing = false;
    restartScanner();
    showMessage('error', `Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„: ${err}`);
  });
}
</script>

</body>
</html>
