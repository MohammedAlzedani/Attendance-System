<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  Â 
  <meta charset="UTF-8" />
  Â 
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  Â  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ (ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆÙ…Ø­Ù„ÙŠ)</title>
  Â 
  <script src="https://cdn.tailwindcss.com"></script>
  Â 
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  Â  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');

    body {
      font-family: 'Cairo', sans-serif;
      background: #f3f6fb;
    }

    .card {
      background: white;
      border-radius: 18px;
      padding: 28px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .08);
      border: 1px solid #e6e9ef;
    }

    .input-box {
      border: 1px solid #d9dce3;
      border-radius: 10px;
      padding: 10px 14px;
    }

    #reader {
      min-height: 240px;
      border: 2px dashed #a5b4fc;
      border-radius: 14px;
      background: #eef2ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .result-box {
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
    }
  </style>
</head>

<body class="p-5 md:p-10">
  Â  <div class="max-w-xl mx-auto">

    Â  Â  <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">
      Â  Â  Â  ğŸ•’ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
      Â  Â  </h2>

    Â  Â  <div id="loginScreen" class="card" style="display:none;">
      Â  Â  Â  Â  <h3 class="text-xl font-semibold mb-6">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      Â  Â  Â  Â  <input id="loginUsername" class="w-full input-box mb-4" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" />
      Â  Â  Â  Â  <input id="loginPassword" class="w-full input-box mb-4" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" />
      Â  Â  Â  Â  <button id="loginButton" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Ø¯Ø®ÙˆÙ„</button>
      Â  Â  Â  Â  <div id="loginError" class="mt-3 text-red-600 text-sm" style="display:none;"></div>
      Â  Â  </div>

    Â  Â  <div id="attendanceApp" style="display:none;">
      Â  Â  Â  Â  <div class="card mb-7">
        Â  Â  Â  Â  <div id="employeeWelcome" class="text-xl font-semibold text-center">
          Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â 
        Â  Â  Â  </div>

      Â  Â  Â  Â  <div class="card">
        Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold mb-4">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>
        Â  Â  Â  Â  Â  Â  <div id="reader">Ø¬Ø§Ø±Ù ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>

        Â  Â  Â  Â  Â  Â  <div class="space-y-3 text-sm mt-4">
          Â  Â  Â  Â  Â  Â  Â  Â  <div id="scanResult" class="result-box bg-blue-50">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          Â  Â  Â  Â  Â  Â  Â  Â  <div id="locationOutput" class="result-box bg-green-50">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          Â  Â  Â  Â  Â  Â  Â  Â  <div id="serverOutput" class="result-box bg-gray-50">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
          Â  Â  Â  Â  Â  Â  Â  </div>

        Â  Â  Â  Â  Â  </div>
      Â  Â  </div>

    Â  </div>

  Â 
  <script>
    const EMPLOYEE_NAME_KEY = 'attendance_employee_name';
    const DEVICE_ID_KEY = 'attendance_device_id';
    const CORRECT_PASSWORD = "Mohammed1993";

    let html5QrCode;
    let currentEmployeeName = "";
    let currentDeviceId = "";
    let isProcessing = false;

    // ğŸ”Š ØµÙˆØª Ù†Ø¬Ø§Ø­
    const successSound = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

    // ğŸ†• Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ø¨Ø³ÙŠØ·
    function generateUniqueId() {
      return 'DEV-' + Math.random().toString(36).substring(2, 9) + Date.now().toString().substring(9);
    }

    function showView(v) {
      loginScreen.style.display = "none";
      attendanceApp.style.display = "none";
      (v === "login" ? loginScreen : attendanceApp).style.display = "block";
    }

    function showLoginError(msg) {
      loginError.textContent = msg;
      loginError.style.display = "block";
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    function handleLogin() {
      const u = loginUsername.value.trim();
      const p = loginPassword.value.trim();
      loginError.style.display = "none";

      if (!u || !p) return showLoginError("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

      if (p === CORRECT_PASSWORD) {
        localStorage.setItem(EMPLOYEE_NAME_KEY, u);
        currentEmployeeName = u;

        employeeWelcome.textContent = `ğŸ‘‹ Welcome ${u}`;

        let storedDeviceId = localStorage.getItem(DEVICE_ID_KEY);
        if (!storedDeviceId) {
          storedDeviceId = generateUniqueId();
          localStorage.setItem(DEVICE_ID_KEY, storedDeviceId);
        }
        currentDeviceId = storedDeviceId;

        showView("form");
        setTimeout(initScanner, 500);
      } else showLoginError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    function handleLogout() {
      if (html5QrCode) html5QrCode.stop().catch(() => { });
      localStorage.removeItem(EMPLOYEE_NAME_KEY);
      currentEmployeeName = "";
      showView("login");
    }

    // Ø±Ø³Ø§Ù„Ø©
    function showMessage(type, msg) {
      let iconText = type === "success" ? "âœ…" : type === "warning" ? "âš ï¸" : "âŒ";
      serverOutput.innerHTML = `${iconText} ${msg}`;

      // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ SweetAlert2 ÙÙ‚Ø· Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„Ø®Ø·Ø£ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      if (type === "success" || type === "error") {
        Swal.fire({
          icon: type,
          title: type === "success" ? 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­' : 'Ø®Ø·Ø£!',
          html: msg,
          confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
          timer: 5000
        });
      }
    }

    // âœ… Ø§Ù„Ø³ÙƒØ§Ù†Ø±
    function onScanSuccess(txt) {
      if (isProcessing) return;
      isProcessing = true;
      successSound.play().catch(() => { });
      scanResult.innerHTML = `âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­: ${txt}`;
      html5QrCode.stop().then(() => processAttendance(txt)).catch(() => processAttendance(txt));
    }

    function initScanner() {
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess)
        .catch(() => showMessage('error', 'ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'));
    }

    function restartScanner() {
      if (!currentEmployeeName || !html5QrCode) return;
      setTimeout(() => initScanner(), 1200);
    }

    // ğŸ“ GPS
    function getLocation(cb) {
      if (!navigator.geolocation) return cb({ error: true, message: "Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…" });
      navigator.geolocation.getCurrentPosition(p => {
        cb({ lat: p.coords.latitude, lon: p.coords.longitude });
      }, () => cb({ error: true, message: "ÙØ¹Ù‘Ù„ GPS" }));
    }

    // ğŸ”„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© - ğŸš¨ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø¨ÙŠÙ†Ø± Ø£ÙˆÙ„Ø§Ù‹
    function processAttendance(site) {

      // 1. Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø§Ù„Ø³Ø¨ÙŠÙ†Ø±) ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø­
      Swal.fire({
        title: 'Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        text: 'ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø´Ø§Ø´Ø©...',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading()
        }
      });

      showMessage('warning', 'Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

      getLocation(loc => {
        if (loc.error) {
          // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø¨ÙŠÙ†Ø± Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          Swal.close();
          showMessage('error', loc.message);
          isProcessing = false;
          restartScanner();
          return;
        }
        locationOutput.innerHTML = `ğŸ“ ${loc.lat}, ${loc.lon}`;

        // 2. Ø§Ù„Ø¢Ù† ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        sendAttendance(site, loc.lat, loc.lon);
      });
    }

    // ğŸ“¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ğŸš¨ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø¥Ø²Ø§Ù„Ø© Ø£Ù…Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø¨ÙŠÙ†Ø±
    function sendAttendance(site, lat, lon) {
      // âŒ ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙƒÙˆØ¯ Swal.fire() Ù…Ù† Ù‡Ù†Ø§

      fetch("https://script.google.com/macros/s/AKfycbzFIPEgOMXah-nJXbCNiTCqgqkqLy3BcbqbMYhh3qXOT2Bo1TbW1v4JCb4fF8wtGv9W/exec", {
        method: "POST",
        body: JSON.stringify({
          employeeName: currentEmployeeName,
          siteName: site,
          timestamp: new Date().toISOString(),
          latitude: lat,
          longitude: lon,
          deviceId: currentDeviceId
        })
      })
        .then(r => r.json()).then(r => {
          isProcessing = false;
          restartScanner();
          // Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
          Swal.close();

          if (r.result === "success") {
            showMessage('success', `
                <p style="text-align: right;">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: <strong>${r.action}</strong></p>
                <p style="text-align: right;">Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹: <strong>${Math.round(r.distance)}Ù…</strong></p>
                ${r.hours ? '<p style="text-align: right;">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: <strong>' + r.hours + '</strong></p>' : ''}
            `);
          } else {
            showMessage('error', r.message || "ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
          }
        }).catch(() => {
          isProcessing = false;
          restartScanner();
          // Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
          Swal.close();
          showMessage('error', 'Ø®Ø·Ø£ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„Ø¯ÙŠÙƒ.');
        });
    }

    // bootstrap
    document.addEventListener('DOMContentLoaded', () => {
      currentEmployeeName = localStorage.getItem(EMPLOYEE_NAME_KEY);
      currentDeviceId = localStorage.getItem(DEVICE_ID_KEY) || "";

      const employeeWelcome = document.getElementById('employeeWelcome');

      if (currentEmployeeName && currentDeviceId) {
        employeeWelcome.textContent = `ğŸ‘‹ Welcome ${currentEmployeeName}`;

        showView("form");
        setTimeout(initScanner, 500);
      } else showView("login");

      loginButton.onclick = handleLogin;
      logoutButton.onclick = handleLogout;
    });
  </script>
</body>

</html>